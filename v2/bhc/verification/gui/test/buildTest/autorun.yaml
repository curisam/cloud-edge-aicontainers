- name: Docker model Generation && Distribution
  hosts: builders
  
  vars:
    image_name: "{{ ansible_facts['architecture'] }}-model"
    registry: None
    tag: None

  tasks:

  ## build new model image
  - name: cpu-arch detection
    debug:
      msg: cpu architecture is {{ ansible_facts['architecture'] }}
  - name: build test
    command: docker build --tag {{ image_name }}:{{ tag }} buildimg/
    register: command_output
  - debug:
      var: command_output.stdout_lines
  

  ## run container & test model
  - name: run container
    command: docker run -d --name model -it {{ image_name }}:{{ tag }}
    register: command_output
  - debug:
      var: command_output.stdout_lines
  - name: model prediction test
    command: docker exec model python home/classifier.py --input test.jpg
    register: command_output
  - debug:
      var: command_output.stdout_lines
  

  ## rename & push model image
  - name: rename model image...
    command: docker tag {{ image_name }}:{{ tag }} {{ registry }}/{{ image_name }}:{{ tag }}
    register: command_output
  - debug:
      var: command_output.stdout_line
  - name: push image...
    command: docker push {{ registry }}/{{ image_name }}:{{ tag }}
    register: command_output
  - debug:
      var: command_output.stdout_lines
  - name: check result...
    command: 
      curl -X GET http://{{ registry }}/v2/_catalog
      curl -X GET http://{{ registry }}/v2/{{ image_name }}/tags/list
    register: command_output
  - debug:
      var: command_output.stdout_lines